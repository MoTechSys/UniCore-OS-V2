// UniCore-OS Database Schema
// Based on MASTER_BLUEPRINT.md specifications
// Version: 1.0.0
// Database: SQLite (Development) / PostgreSQL (Production)

generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output = "../docs/ERD.svg"
  theme = "dark"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE USER & AUTH
// ============================================

model User {
  id              String      @id @default(cuid())
  academicId      String      @unique // الرقم الجامعي
  nationalId      String?     // رقم الهوية (للتحقق عند التفعيل)
  email           String?     @unique
  passwordHash    String?
  status          String      @default("PENDING_ACTIVATION") // PENDING_ACTIVATION, ACTIVE, FROZEN
  tokenVersion    Int         @default(0) // لإبطال التوكنات
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft Delete
  lastLoginAt     DateTime?
  
  // Relations
  profile         UserProfile?
  roles           UserRole[]
  enrollments     Enrollment[]
  quizAttempts    QuizAttempt[]
  createdQuizzes  Quiz[]       @relation("QuizCreator")
  auditLogs       AuditLog[]   @relation("AuditActor")
  notifications   Notification[]
  uploadedFiles   File[]       @relation("FileUploader")
}

model UserProfile {
  id              String      @id @default(cuid())
  userId          String      @unique
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Info
  firstNameAr     String
  lastNameAr      String
  firstNameEn     String?
  lastNameEn      String?
  phone           String?
  avatarUrl       String?
  
  // Academic Info
  majorId         String?
  major           Major?      @relation(fields: [majorId], references: [id])
  level           Int?        // المستوى الدراسي
  gpa             Float?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// ============================================
// DYNAMIC RBAC (الصلاحيات الديناميكية)
// ============================================

model Permission {
  id              String      @id @default(cuid())
  code            String      @unique // e.g., "course.create", "exam.grade"
  nameAr          String
  nameEn          String
  category        String      // e.g., "courses", "exams", "users"
  description     String?
  
  roles           RolePermission[]
}

model Role {
  id              String      @id @default(cuid())
  code            String      @unique
  nameAr          String
  nameEn          String?
  description     String?
  isSystem        Boolean     @default(false) // Super Admin فقط
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft Delete
  
  permissions     RolePermission[]
  users           UserRole[]
}

model RolePermission {
  id              String      @id @default(cuid())
  roleId          String
  role            Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId    String
  permission      Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
}

model UserRole {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId          String
  role            Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  assignedAt      DateTime    @default(now())
  assignedBy      String?     // من قام بالتعيين
  
  @@unique([userId, roleId])
}

// ============================================
// ACADEMIC HIERARCHY (الهيكل الأكاديمي)
// ============================================

model College {
  id              String      @id @default(cuid())
  code            String      @unique
  nameAr          String
  nameEn          String?
  description     String?
  isActive        Boolean     @default(true)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft Delete
  
  departments     Department[]
}

model Department {
  id              String      @id @default(cuid())
  code            String      @unique
  nameAr          String
  nameEn          String?     
  description     String?
  isActive        Boolean     @default(true)
  
  collegeId       String
  college         College     @relation(fields: [collegeId], references: [id])
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft Delete
  
  majors          Major[]
  courses         Course[]
}

model Major {
  id              String      @id @default(cuid())
  code            String      @unique
  nameAr          String
  nameEn          String?
  description     String?
  isActive        Boolean     @default(true)
  totalCredits    Int         @default(0)
  
  departmentId    String
  department      Department  @relation(fields: [departmentId], references: [id])
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft Delete
  
  students        UserProfile[]
}

// ============================================
// COURSES & OFFERINGS (المقررات والشعب)
// ============================================

model Course {
  id              String      @id @default(cuid())
  code            String      @unique // e.g., "CS101"
  nameAr          String
  nameEn          String?
  description     String?
  credits         Int         @default(3)
  isActive        Boolean     @default(true)
  
  departmentId    String
  department      Department  @relation(fields: [departmentId], references: [id])
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft Delete
  
  offerings       CourseOffering[]
}

model Semester {
  id              String       @id @default(cuid())
  code            String       @unique // e.g., "2025-1"
  nameAr          String
  nameEn          String?
  type            String       // FIRST, SECOND, SUMMER
  year            Int
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean      @default(false)
  isCurrent       Boolean      @default(false)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  offerings       CourseOffering[]
}

model CourseOffering {
  id              String      @id @default(cuid())
  code            String      @unique // Auto-generated: CS101-2025-1-001
  
  courseId        String
  course          Course      @relation(fields: [courseId], references: [id])
  
  semesterId      String
  semester        Semester    @relation(fields: [semesterId], references: [id])
  
  instructorId    String      // الدكتور المسؤول
  
  section         String      @default("1") // رقم الشعبة
  maxStudents     Int         @default(50)
  isActive        Boolean     @default(true)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft Delete
  
  enrollments     Enrollment[]
  quizzes         Quiz[]
  files           File[]
  
  @@unique([courseId, semesterId, section])
}

model Enrollment {
  id              String      @id @default(cuid())
  
  studentId       String
  student         User        @relation(fields: [studentId], references: [id])
  
  offeringId      String
  offering        CourseOffering @relation(fields: [offeringId], references: [id])
  
  enrolledAt      DateTime    @default(now())
  droppedAt       DateTime?
  
  @@unique([studentId, offeringId])
}

// ============================================
// QUIZ ENGINE (محرك الاختبارات)
// ============================================

model Quiz {
  id              String      @id @default(cuid())
  title           String
  description     String?
  
  offeringId      String
  offering        CourseOffering @relation(fields: [offeringId], references: [id])
  
  creatorId       String
  creator         User        @relation("QuizCreator", fields: [creatorId], references: [id])
  
  status          String      @default("DRAFT") // DRAFT, PUBLISHED, CLOSED
  duration        Int         @default(30) // بالدقائق
  totalPoints     Float       @default(0)
  passingScore    Float       @default(60) // النسبة المئوية للنجاح
  
  shuffleQuestions Boolean    @default(false)
  shuffleOptions   Boolean    @default(false)
  showResults      Boolean    @default(true)
  allowReview      Boolean    @default(true)
  
  startTime       DateTime?
  endTime         DateTime?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft Delete
  
  questions       Question[]
  attempts        QuizAttempt[]
}

model Question {
  id              String         @id @default(cuid())
  
  quizId          String
  quiz            Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  type            String         // MULTIPLE_CHOICE, TRUE_FALSE, SHORT_ANSWER
  difficulty      String         @default("MEDIUM") // EASY, MEDIUM, HARD
  text            String
  explanation     String?        // شرح الإجابة الصحيحة
  points          Float          @default(1)
  order           Int            @default(0)
  
  isAiGenerated   Boolean        @default(false)
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  options         Option[]
  answers         Answer[]
}

model Option {
  id              String      @id @default(cuid())
  
  questionId      String
  question        Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  text            String
  isCorrect       Boolean     @default(false)
  order           Int         @default(0)
  
  answers         Answer[]
}

model QuizAttempt {
  id              String        @id @default(cuid())
  
  quizId          String
  quiz            Quiz          @relation(fields: [quizId], references: [id])
  
  studentId       String
  student         User          @relation(fields: [studentId], references: [id])
  
  status          String        @default("IN_PROGRESS") // IN_PROGRESS, SUBMITTED, GRADED
  score           Float?
  percentage      Float?
  
  startedAt       DateTime      @default(now())
  submittedAt     DateTime?
  gradedAt        DateTime?
  
  answers         Answer[]
  
  @@unique([quizId, studentId])
}

model Answer {
  id              String      @id @default(cuid())
  
  attemptId       String
  attempt         QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  questionId      String
  question        Question    @relation(fields: [questionId], references: [id])
  
  selectedOptionId String?
  selectedOption   Option?    @relation(fields: [selectedOptionId], references: [id])
  
  textAnswer      String?     // للأسئلة المقالية
  isCorrect       Boolean?
  pointsEarned    Float?
  
  answeredAt      DateTime    @default(now())
  
  @@unique([attemptId, questionId])
}

// ============================================
// FILES & STORAGE (الملفات)
// ============================================

model File {
  id              String      @id @default(cuid())
  
  name            String
  originalName    String
  mimeType        String
  size            Int         // بالبايت
  path            String
  url             String?
  
  offeringId      String?
  offering        CourseOffering? @relation(fields: [offeringId], references: [id])
  
  uploaderId      String
  uploader        User        @relation("FileUploader", fields: [uploaderId], references: [id])
  
  createdAt       DateTime    @default(now())
  deletedAt       DateTime?   // Soft Delete
}

// ============================================
// NOTIFICATIONS (الإشعارات)
// ============================================

model Notification {
  id              String      @id @default(cuid())
  
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title           String
  body            String
  type            String      // e.g., "quiz_published", "grade_released"
  data            String?     // JSON string for SQLite
  
  isRead          Boolean     @default(false)
  readAt          DateTime?
  
  createdAt       DateTime    @default(now())
}

// ============================================
// AUDIT LOG (سجل التدقيق)
// ============================================

model AuditLog {
  id              String      @id @default(cuid())
  
  actorId         String?
  actor           User?       @relation("AuditActor", fields: [actorId], references: [id])
  
  action          String      // e.g., "user.create", "quiz.delete"
  entityType      String      // e.g., "User", "Quiz"
  entityId        String?
  
  oldData         String?     // JSON string for SQLite
  newData         String?     // JSON string for SQLite
  metadata        String?     // JSON string for SQLite (IP, User Agent, etc.)
  
  createdAt       DateTime    @default(now())
}

// ============================================
// SYSTEM SETTINGS (إعدادات النظام)
// ============================================

model SystemSetting {
  id              String      @id @default(cuid())
  key             String      @unique
  value           String
  type            String      @default("string") // string, number, boolean, json
  description     String?
  
  updatedAt       DateTime    @updatedAt
}
